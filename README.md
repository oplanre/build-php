# PHP build system

This repository delves into the heart of the PHP build system and explores how
to build PHP with CMake.

![ElePHPant](docs/images/elephpant.jpg)

## 1. Index

* [1. Index](#1-index)
* [2. Introduction](#2-introduction)
* [3. PHP directory structure](#3-php-directory-structure)
* [4. PHP extensions](#4-php-extensions)
* [5. PHP SAPI (Server API) modules](#5-php-sapi-server-api-modules)
* [6. Parser and lexer files](#6-parser-and-lexer-files)
* [7. \*nix build system](#7-nix-build-system)
  * [7.1. \*nix build system diagram](#71-nix-build-system-diagram)
  * [7.2. Build requirements](#72-build-requirements)
  * [7.3. The configure command line options](#73-the-configure-command-line-options)
* [8. Windows build system](#8-windows-build-system)
  * [8.1. Windows prerequisites](#81-windows-prerequisites)
* [9. CMake](#9-cmake)
  * [9.1. Why using CMake?](#91-why-using-cmake)
  * [9.2. Installation](#92-installation)
  * [9.3. Directory structure](#93-directory-structure)
  * [9.4. CMake build system diagram](#94-cmake-build-system-diagram)
  * [9.5. CMake usage](#95-cmake-usage)
  * [9.6. CMake minimum version for PHP](#96-cmake-minimum-version-for-php)
  * [9.7. CMake code style](#97-cmake-code-style)
  * [9.8. Command line options](#98-command-line-options)
  * [9.9. CMake generators for building PHP](#99-cmake-generators-for-building-php)
    * [9.9.1. Unix Makefiles (default)](#991-unix-makefiles-default)
    * [9.9.2. Ninja](#992-ninja)
  * [9.10. CMake presets](#910-cmake-presets)
  * [9.11. CMake GUI](#911-cmake-gui)
  * [9.12. Testing](#912-testing)
  * [9.13. Performance](#913-performance)
  * [9.14. Installing PHP with CMake](#914-installing-php-with-cmake)
* [10. See more](#10-see-more)
  * [10.1. Autotools](#101-autotools)
  * [10.2. CMake](#102-cmake)
  * [10.3. CMake and PHP](#103-cmake-and-php)
  * [10.4. PHP Internals](#104-php-internals)

## 2. Introduction

PHP developers typically opt for convenient methods to set up PHP on their
machines, such as utilizing prebuilt Linux packages available in their Linux
distribution repositories, deploying Docker images, or relying on user-friendly
stacks that bundle PHP, its extensions, web server, and database into a unified
installation package.

```sh
# Debian-based distributions:
sudo apt install php...

# Fedora-based distributions:
sudo dnf install php...
```

In contrast, the practice of building PHP from source code is primarily reserved
for specific purposes, such as PHP source code development or extensive
customization of PHP configurations on a particular system. This approach is
less commonly employed by everyday PHP developers due to its intricate and
time-consuming nature.

In the realm of software development, a build system is a collection of tools
and files that automate the process of compiling, linking, and assembling the
project's source code into its final form, ready to be executed. It helps
developers with repetitive tasks and ensures consistency and correctness in the
build process for various platforms and hardware out there.

There are many well known build systems for C projects out there. From the
veteran GNU Autotools, popular CMake, Ninja, SCons, Meson, to the simplest
manual usage of Make.

PHP build system consist of two parts:

* \*nix build system (Linux, macOS, FreeBSD, OpenBSD, etc.)
* Windows build system

## 3. PHP directory structure

Before we begin, it might be useful to understand directory structure of the PHP
source code. PHP is developed at the
[php-src GitHub repository](https://github.com/php/php-src).

After cloning the repository:

```sh
git clone https://github.com/php/php-src
cd php-src
```

you end up with a large monolithic repository consisting of C source code files,
PHP tests and other files:

```sh
<php-src>/
 ├─ .git/                     # Git configuration and source directory
 ├─ appveyor/                 # Appveyor CI service files
 ├─ benchmark/                # Benchmark some common applications in CI
 ├─ build/                    # *nix build system files
 ├─ docs/                     # PHP internals documentation
 └─ ext/                      # PHP core extensions
    └─ bcmath/                # The bcmath PHP extension
       ├─ libbcmath/          # The bcmath library forked and maintained in php-src
       ├─ tests/              # *.phpt test files for extension
       ├─ bcmath.stub.php     # A stub file for the bcmath extension functions
       └─ ...
    └─ curl/                  # The curl PHP extension
       ├─ sync-constants.php  # The curl symbols checker
       └─ ...
    └─ date/                  # The date/time PHP extension
       └─ lib/                # Bundled datetime library https://github.com/derickr/timelib
          └─ ...
       └─ ...
    ├─ dl_test/               # Extension for testing dl()
    └─ ffi/                   # The FFI PHP extension
       ├─ ffi_parser.c        # Generated by https://github.com/dstogov/llk
       └─ ...
    └─ fileinfo/              # The fileinfo PHP extension
       ├─ libmagic/           # Modified libmagic https://github.com/file/file
       ├─ data_file.c         # Generated by `ext/fileinfo/create_data_file.php`
       ├─ libmagic.patch      # Modifications patch from upstream libmagic
       ├─ magicdata.patch     # Modifications patch from upstream libmagic
       └─ ...
    └─ gd/                    # The GD PHP extension
       ├─ libgd/              # Bundled and modified GD library https://github.com/libgd/libgd
       └─ ...
    └─ mbstring/              # The Multibyte string PHP extension
       ├─ libmbfl/            # Forked and maintained in php-src
       ├─ unicode_data.h      # Generated by `ext/mbstring/ucgendat/ucgendat.php`
       └─ ...
    └─ opcache/               # The OPcache PHP extension
       └─ jit/                # OPcache Jit
          └─ dynasm/          # DynASM ARM encoding engine
             ├─ minilua.c     # Customized Lua scripting language to build LuaJIT
             └─ ...
          ├─ zend_jit_x86.c   # Generated by minilua
          └─ ...
    └─ pcre/                  # The PCRE PHP extension
       ├─ pcre2lib/           # https://www.pcre.org/
       └─ ...
    ├─ skeleton/              # Skeleton for developing new extensions with `ext/ext_skel.php`
    └─ standard/              # Always enabled core extension
       └─ html_tables/
          ├─ mappings/        # https://www.unicode.org/Public/MAPPINGS/
          └─ ...
       ├─ credits_ext.h       # Generated by `scripts/dev/credits`
       ├─ credits_sapi.h      # Generated by `scripts/dev/credits`
       ├─ html_tables.h       # Generated by `ext/standard/html_tables/html_table_gen.php`
       └─ ...
    └─ tokenizer/             # The tokenizer PHP extension
       ├─ tokenizer_data.c    # Generated by `ext/tokenizer/tokenizer_data_gen.sh`
       └─ ...
    └─ zend_test              # For testing internal APIs. Not needed for regular builds
       └─ ...
    └─ zip/                   # Bundled https://github.com/pierrejoye/php_zip
       └─ ...
    ├─ ...
    └─ ext_skel.php           # Helper script that creates a new PHP extension
 └─ main/                     # Binding that ties extensions, SAPIs, Zend engine and TSRM together
    ├─ streams/               # Streams layer subsystem
    └─ ...
 ├─ pear/                     # PEAR installation
 └─ sapi/                     # PHP SAPI (Server API) modules
    └─ cli/                   # Command line PHP SAPI module
       ├─ mime_type_map.h     # Generated by `sapi/cli/generate_mime_type_map.php`
       └─ ...
    └─ ...
 ├─ scripts/                  # php-config, phpize and internal development scripts
 ├─ tests/                    # Core features tests
 ├─ travis/                   # Travis CI service files
 ├─ TSRM/                     # Thread safe resource manager
 └─ Zend/                     # Zend engine
    ├─ asm/                   # Bundled from src/asm in https://github.com/boostorg/context
    ├─ Optimizer/             # For faster PHP execution through opcode caching and optimization
    ├─ tests/                 # PHP tests *.phpt files for Zend engine
    ├─ zend_vm_execute.h      # Generated by `Zend/zend_vm_gen.php`
    ├─ zend_vm_opcodes.c      # Generated by `Zend/zend_vm_gen.php`
    ├─ zend_vm_opcodes.h      # Generated by `Zend/zend_vm_gen.php`
    └─ ...
 └─ win32/                    # Windows build system files
    ├─ cp_enc_map.c           # Generated by `win32/cp_enc_map_gen.exe`
    └─ ...
 └─ ...
```

The following diagram briefly displays, how PHP libraries (in terms of a build
system) are linked together:

![Diagram how PHP libraries are linked together](docs/images/links.svg)

## 4. PHP extensions

PHP has several ways to install PHP extensions:

* Bundled

  This is the default way. Extension is built together with PHP sapi and no
  enabling is needed in the `php.ini` configuration.

* Shared

  This installs the extension as dynamically loadable library. Extension to be
  visible in the PHP sapi (see `php -m`) needs to be also manually enabled in
  the `php.ini` configuration:

  ```ini
  # On *nix systems:
  extension=php_extension_name.so

  # Or on Windows:
  extension=php_extension_name.dll
  ```

The following extensions are always enabled and are part of the overall PHP
engine source code:

* `ext/date`
* `ext/hash`
* `ext/json`
* `ext/random`
* `ext/reflection`
* `ext/pcre`
* `ext/spl`
* `ext/standard`

PHP extensions ecosystem also consists of the [PECL](https://pecl.php.net)
extensions. These can be installed with a separate tool `pecl`:

```sh
pecl install php_extension_name
```

PECL tool is a simple shell script wrapper around the PHP code as part of the
[pear-core](https://github.com/pear/pear-core/blob/master/scripts/pecl.sh)
repository.

## 5. PHP SAPI (Server API) modules

PHP works through the concept of SAPI modules located in the `sapi` directory.

When running PHP in command line, the cli SAPI module is used:

```sh
/sapi/cli/php -v
```

* [Embed SAPI module](/docs/embed.md)

There are other SAPI modules located in the ecosystem:

* [frankenphp](https://github.com/dunglas/frankenphp)
* [ngx-php](https://github.com/rryqszq4/ngx-php)
* ...

## 6. Parser and lexer files

Some source files are generated with 3rd party tools. These include so called
parser and lexer files which are generated with [re2c](https://re2c.org/) and
[bison](https://www.gnu.org/software/bison/).

Parser files are generated from `*.y` source using `bison` tool to C source code
and header files.

Lexer files are generated from `*.l` and `*.re` source files using `re2c` tool
to C source code and header files.

There is a helper shell script available that generates all these files when
developing PHP source, otherwise they are generated upon `make` step based on
the `Makefile.frag` files.

```sh
./scripts/dev/genfiles
```

```sh
<php-src>/
 └─ build/
    ├─ php.m4                       # PHP Autoconf macros (re2c and bison macros are here)
    └─ ...
 └─ ext/
    ├─ ...
    └─ date/
       └─ lib/
          ├─ parse_date.c           # Generated by re2c 0.15.3
          ├─ parse_iso_intervals.c  # Generated by re2c 0.15.3
          └─ ...
       └─ ...
    └─ ffi/
       ├─ ffi_parser.c              # Manually generated by https://github.com/dstogov/llk
       └─ ...
    └─ json/
       ├─ json_parser.tab.c         # Generated with bison
       ├─ json_parser.tab.h         # Generated with bison
       ├─ json_parser.y             # Parser source
       ├─ json_scanner.c            # Generated with re2c
       ├─ json_scanner.re           # Lexer source
       ├─ Makefile.frag             # Makefile fragment
       ├─ php_json_scanner_defs.h   # Generated with re2c
       └─ ...
    └─ pdo/
       ├─ Makefile.frag             # Makefile fragment
       ├─ pdo_sql_parser.c          # Generated with re2c
       ├─ pdo_sql_parser.re         # Source for re2c
       └─ ...
    └─ phar/
       ├─ Makefile.frag             # Makefile fragment
       ├─ phar_path_check.c         # Generated with re2c
       ├─ phar_path_check.re        # Source for re2c
       └─ ...
    └─ standard/
       ├─ Makefile.frag             # Makefile fragment
       ├─ url_scanner_ex.c          # Generated with re2c
       ├─ url_scanner_ex.re         # Source for re2c
       ├─ var_unserializer.c        # Generated with re2c
       ├─ var_unserializer.re       # Source for re2c
       └─ ...
    └─ ...
 └─ sapi/
    └─ phpdbg/
       ├─ phpdbg_lexer.c            # Generated with re2c
       ├─ phpdbg_lexer.l            # Source for re2c
       ├─ phpdbg_parser.c           # Generated with bison
       ├─ phpdbg_parser.h           # Generated with bison
       ├─ phpdbg_parser.y           # Source for bison
       ├─ phpdbg_parser.output      # Generated with bison
       └─ ...
    └─ ...
 └─ scripts/
    └─ dev/
       ├─ genfiles                  # Parser and lexer files generator helper
       └─ ...
    └─ ...
 └─ Zend/
    ├─ Makefile.frag                # Part of Makefile related to Zend files
    ├─ zend_ini_parser.c            # Generated with bison
    ├─ zend_ini_parser.h            # Generated with bison
    ├─ zend_ini_parser.output       # Generated with bison
    ├─ zend_ini_parser.y            # Parser source
    ├─ zend_ini_scanner.c           # Generated with re2c
    ├─ zend_ini_scanner.l           # Lexer source
    ├─ zend_ini_scanner_defs.h      # Generated with re2c
    ├─ zend_language_parser.c       # Generated with bison
    ├─ zend_language_parser.h       # Generated with bison
    ├─ zend_language_parser.output  # Generated with bison
    ├─ zend_language_parser.y       # Parser source
    ├─ zend_language_scanner_defs.h # Generated with re2c
    ├─ zend_language_scanner.c      # Generated with re2c
    ├─ zend_language_scanner.l      # Lexer source
    └─ ...
 ├─ configure.ac                    # Minimum re2c and bison versions settings
 └─ ...
```

## 7. \*nix build system

\*nix build system in PHP uses [Autoconf](https://www.gnu.org/software/autoconf/)
to build a `configure` shell script that further creates main `Makefile` to
build sources to executable binaries.

```sh
./buildconf
./configure
make
```

The `buildconf` is a simple shell script wrapper around `autoconf` and
`autoheader` tools that checks required Autoconf version. It creates `configure`
command line script and `main/php_config.h.in` header template.

When running the `./configure`, many checks are done based on the running
system. Things like C headers availability, C symbols, required library
dependencies etc.

The `configure` script creates `Makefile` where the `make` command then builds
binary files from C source files. You can optionally pass the `-j` option which
is the number of threads on current system, so it builds faster.

```sh
make -j $(nproc)
```

When compiling is done, the tests can be run with:

```sh
make TEST_PHP_ARGS=-j10 test
```

PHP \*nix build system is pretty much standard GNU Autotools build system with
few customizations. It doesn't use Automake and it bundles some 3rd party files
for easier installation across various systems out there without requiring
installation dependencies. Autotools is a veteran build system present since
early C/C++ days. It is used for most Linux ecosystem out there and it might
cause issues for C developers today.

Build system is a collection of various files across the php-src repository:

```sh
<php-src>/
 └─ build/
    ├─ ax_*.m4             # https://github.com/autoconf-archive/autoconf-archive
    ├─ config-stubs        # Adds extension and sapi config*.m4 stubs to configure
    ├─ config.guess        # https://git.savannah.gnu.org/cgit/config.git
    ├─ config.sub          # https://git.savannah.gnu.org/cgit/config.git
    ├─ genif.sh            # Generator for the internal_functions* files
    ├─ libtool.m4          # Forked https://git.savannah.gnu.org/cgit/libtool.git
    ├─ ltmain.sh           # Forked https://git.savannah.gnu.org/cgit/libtool.git
    ├─ Makefile.global     # Root Makefile template when configure is run
    ├─ order_by_dep.awk    # Used by genif.sh
    ├─ php.m4              # PHP Autoconf macros
    ├─ pkg.m4              # https://gitlab.freedesktop.org/pkg-config/pkg-config
    ├─ print_include.awk   # Used by genif.sh
    ├─ shtool              # https://www.gnu.org/software/shtool/
    └─ ...
 └─ ext/
    └─ bcmath/
       ├─ config.m4        # Extension's Autoconf file
       └─ ...
    └─ date/
       ├─ config0.m4       # Suffix 0 is priority which includes the file before other config.m4 extension files
       └─ ...
    └─ mysqlnd/
       ├─ config9.m4       # Suffix 9 priority includes the file after other config.m4 files
       └─ ...
    └─ opcache/
       └─ jit/
          ├─ Makefile.frag # Makefile fragment for OPcache Jit
          └─ ...
       ├─ config.m4        # Autoconf file for OPcache extension
       └─ ...
    └─ ...
 └─ main/
    ├─ php_version.h       # Generated by release managers using `configure`
    └─ ...
 ├─ pear/
 └─ sapi/
    └─ cli/
       ├─ config.m4        # Autoconf M4 file for CLI sapi
       └─ ...
    └─ ...
 ├─ scripts/
 └─ TSRM/
    ├─ threads.m4          # Autoconf macros for pthreads
    ├─ tsrm.m4             # Autoconf macros for TSRM directory
    └─ ...
 └─ Zend/
    ├─ Makefile.frag       # Makefile fragment for Zend engine
    ├─ Zend.m4             # Autoconf macros for Zend directory
    └─ ...
 ├─ buildconf              # Wrapper for autoconf and autoheader tools
 ├─ configure.ac           # Autoconf main input file for constructing configure script
 └─ ...
```

### 7.1. \*nix build system diagram

![PHP *nix build system using Autotools](docs/images/autotools.svg)

### 7.2. Build requirements

Before being able to built PHP on Linux and other \*nix systems, there are some
3rd party requirements that need to be installed. Note that these names differ
from system to system. Here, a simplifed names are used. For building PHP from
source, you will need a library with development files. Such libraries are
packaged with names of `libfoo-dev`, `libfoo-devel`, or similar. For example,
for the `libzip` library below, install the `libzip-dev` (or `libzip-devel`)
package.

Required:

* autoconf
* make
* gcc
* g++
* pkg-config
* libxml
* libsqlite3

Additionally required when building from Git repository source code:

* bison
* re2c

Optional:

* libcapstone (for the OPcache `--with-capstone` option)
* libssl (for OpenSSL `--with-openssl`)
* libkrb5 (for the OpenSSL `--with-kerberos` option)
* libaspell and libpspell (for the ext/pspell `--with-pspell` option)
* zlib
  * when using `--enable-gd` with bundled libgd
  * when using `--with-zlib`
  * when using `--with-pdo-mysql` or `--with-mysqli` (option
    `--enable-mysqlnd-compression-support` needs it)
* libpng
  * when using `--enable-gd` with bundled libgd
* libavif
  * when using `--enable-gd` with bundled libgd and `--with-avif` option.
* libwebp
  * when using `--enable-gd` with bundled libgd and `--with-webp` option.
* libjpeg
  * when using `--enable-gd` with bundled libgd and `--with-jpeg` option.
* libxpm
  * when using `--enable-gd` with bundled libgd and `--with-xpm` option.
* libfretype
  * when using `--enable-gd` with bundled libgd and `--with-freetype` option.
* libgd
  * when using `--enable-gd` with external libgd `--with-external-gd`.
* libonig
  * when using `--enable-mbstring`
* libtidy
  * when using `--with-tidy`
* libxslt
  * when using `--with-xsl`
* libzip
  * when using `--with-zip`
* libargon2
  * when using `--with-password-argon2`
* libedit
  * when using `--with-libedit`
* libreadline
  * when using `--with-readline`
* libsnmp
  * when using `--with-snmp`
* libexpat1
  * when using the `--with-expat`
* libacl
  * when using the `--with-fpm-acl`
* libapparmor
  * when using the `--with-fpm-apparmor`
* libselinux1
  * when using the `--with-fpm-selinux`

When PHP is built, the development libraries are no longer required to be
installed and only libraries without development files are needed to run newly
built PHP. In example of `ext/zip` extension, the `libzip` package is needed and
so on.

### 7.3. The configure command line options

With Autoconf, there are two main types of command line options for the
`configure` script (`--enable-FEATURE` and `--with-PACKAGE`):

* `--enable-FEATURE[=ARG]` and its belonging opposite `--disable-FEATURE`

  `--disable-FEATURE` is the same as `--enable-FEATURE=no`

  These normally don't require 3rd party library or package installed on the
  system. For some extensions, PHP bundles 3rd party dependencies in the
  extension itself. For example, `bcmath`, `gd`, etc.

* `--with-PACKAGE[=ARG]` and its belonging opposite `--without-PACKAGE`

  `--without-PACKAGE` is the same as `--with-PACKAGE=no`

  These require 3rd party package installed on the system. PHP has even some
  libraries bundled in PHP source code. For example, the PCRE library and
  similar.

Others custom options that don't follow this pattern are used for adjusting
specific features during built process.

See `./configure --help` for more info.

This wraps up the \*nix build system using the Autotools.

## 8. Windows build system

Windows build system is a separate collection of
[JScript](https://en.wikipedia.org/wiki/JScript) files and command line scripts.
Some files are manually created unlike with Autoconf. For example, header files.
Similarly to `*.m4` files there are `*.w32` files for each extension and SAPI
module.

```sh
<php-src>/
 └─ ext/
    └─ bcmath/
       ├─ config.w32           # Extension's Windows build system item file
       └─ ...
    └─ iconv/
       ├─ config.w32           # Extension's Windows build system item file
       ├─ php_iconv.def        # Module-definition file for linker when building DLL
       └─ ...
    └─ opcache/
       └─ jit/
          ├─ Makefile.frag.w32 # Makefile fragment for OPcache Jit
          └─ ...
       ├─ config.w32           # Windows build system script item
       └─ ...
    └─ ...
 └─ main/
    ├─ php_version.h           # Generated by release managers using `configure`
    └─ ...
 └─ sapi/
    └─ cli/
       ├─ config.w32           # Windows build system item file for CLI sapi
       └─ ...
    └─ ...
 └─ win32/                     # Windows build system and code adjusted for Windows
    └─ build/                  # Windows build system configuration and scripts
       ├─ Makefile             # Windows build system Makefile template
       └─ ...
    └─ ...
 └─ TSRM/
    ├─ config.w32              # Windows build system script item
    └─ ...
 └─ Zend/
    ├─ zend_config.w32.h       # Windows configuration header for Zend directory
    └─ ...
 ├─ buildconf.bat              # Windows build system configuration builder
 └─ ...
```

### 8.1. Windows prerequisites

* Windows operating system.
* Visual Studio installed (e.g., Visual Studio 2019 or later).
* Git installed (download from https://git-scm.com/downloads).
* PHP source code downloaded from the PHP website (https://www.php.net/downloads.php).

Documentation to build PHP on Windows is available at [PHP Wiki](https://wiki.php.net/internals/windows/stepbystepbuild_sdk_2).

## 9. CMake

[CMake](https://cmake.org/) is another open-source cross-platform build system
created by Kitware and contributors. This is what this repository is focusing
on.

To learn CMake there is a very good
[documentation](https://cmake.org/cmake/help/latest/index.html) available and a
[tutorial](https://cmake.org/cmake/help/latest/guide/tutorial/index.html) which
is a prerequisite to follow the files in this repository.

### 9.1. Why using CMake?

CMake is today more actively developed and more developers might be familiar
with it. It also makes C code more attractive to new contributors. Many IDEs
provide a good CMake integration for C/C++ projects.

Many things are very similar to Autoconf, which makes maintaining multiple build
systems simpler.

CMake also has a better out of the box support in Windows systems, where
Autotools can run into issues without further adaptations and adjustments in the
build process.

Even though Autotools might be complex and arcane to new developers not
famililar with it, it can still be a very robust and solid build system option
in C/C++ projects on \*nix systems. Many large open-source projects use
Autotools. Some even use it together with CMake.

### 9.2. Installation

Follow these steps to use CMake build system in PHP using this repository:

```sh
# Clone this repository
git clone https://github.com/petk/php-build-system
cd php-build-system

# Download latest PHP sources and add CMake files to them
./bin/php.cmake

# Go into newly created directory, for example
cd php-8.4-dev

# Generate build system
cmake .

# Build PHP binaries and libraries
cmake --build . -- --jobs $(nproc)

./sapi/cli/php -v

# Run tests
./sapi/cli/php run-tests.php -j$(nproc)
```

### 9.3. Directory structure

Directory structure from the CMake perspective looks like this:

```sh
<php-src>/
 └─ cmake/                # CMake files
    └─ modules/           # Project specific CMake modules
       ├─ */              # Directories with parts belonging to PHP modules
       ├─ Find*.cmake     # CMake find modules that support the find_package()
       └─ PHP*.cmake      # PHP custom CMake utility modules
    ├─ cmake-format.json  # Configuration for cmake-lint and cmake-format tools
    └─ ...
 └─ ext/
    └─ bcmath/
       ├─ CMakeLists.txt  # Extension's CMake file
       └─ ...
    └─ date/
       ├─ CMakeLists.txt  # Extension's CMake file
       └─ ...
    └─ ...
 └─ main/
    ├─ php_version.h      # Generated by release managers using `configure`
    ├─ CMakeLists.txt     # CMake file for main binding
    └─ ...
 └─ pear/
    ├─ CMakeLists.txt     # CMake file for PEAR
    └─ ...
 └─ sapi/
    └─ cli/
       ├─ CMakeLists.txt  # CMake file for SAPI module
       └─ ...
    └─ ...
 ├─ scripts/
 └─ TSRM/
    ├─ CMakeLists.txt     # CMake file for thread safe resource manager
    └─ ...
 └─ Zend/
    ├─ CMakeLists.txt     # Zend engine CMake file
    └─ ...
 ├─ CMakeLists.txt        # Root CMake file
 ├─ CMakePresets.json     # Main CMake presets file
 └─ ...
```

### 9.4. CMake build system diagram

![PHP build system using CMake](docs/images/cmake.svg)

### 9.5. CMake usage

```sh
cmake .
cmake --build .
```

### 9.6. CMake minimum version for PHP

The minimum required version of CMake is defined in the top project file
`CMakeLists.txt` using the `cmake_minimum_required()`. Picking the minimum
required build system version is a compromise between build system
functionalities and version available on the operating system.

* 3.17
  * To have `CMAKE_CURRENT_FUNCTION_LIST_DIR` variable available
* 3.19
  * To be able to use `CMakePresets.json` for sharing build configurations
* 3.20
  * To have CMAKE_C_BYTE_ORDER, otherwise manual check should be done
  * To be able to use `"version": 2` in `CMakePresets.json`
* 3.21
  * To be able to use `"version": 3` in `CMakePresets.json` (for the
    `installDir` option).
* 3.23
  * To be able to use `target_sources(FILE_SET)`, otherwise `install(FILES)`
    should be used, when installing PHP built files to their destinations.
* 3.25

Currently, the CMake minimum version is set to **3.25** without looking at CMake
available version on the current systems out there. This will be updated more
properly in the future.

CMake versions scheme across the systems is available at
[pkgs.org](https://pkgs.org/download/cmake).

### 9.7. CMake code style

To sync the code style of the CMake files there are a couple of tools available.
See [docs/cmake-code-style.md](docs/cmake-code-style.md) for more info.

### 9.8. Command line options

List of configure command line options and their CMake alternatives.

These can be passed like this:

```sh
# With Autotools:
./configure --enable-FEATURE --with-PACKAGE ...

# With CMake at the configuration phase:
cmake . -DEXT_NAME=ON -DPHP_OPTION=ON ...
```

| configure                                        | CMake                                         | Default value/notes |
| ------------------------------------------------ | --------------------------------------------- | ------------------  |
| `--disable-re2c-cgoto` (default)                 | `PHP_RE2C_CGOTO=OFF`                          | `OFF`               |
| `--enable-re2c-cgoto`                            | `PHP_RE2C_CGOTO=ON`                           |                     |
| `--disable-debug-assertions` (default)           | `PHP_DEBUG_ASSERTIONS=OFF`                    | `OFF`               |
| `--enable-debug-assertions`                      | `PHP_DEBUG_ASSERTIONS=ON`                     |                     |
| `--disable-sigchild` (default)                   | `PHP_SIGCHILD=OFF`                            | `OFF`               |
| `--enable-sigchild`                              | `PHP_SIGCHILD=ON`                             |                     |
| `--disable-debug` (default)                      | `PHP_DEBUG=OFF`                               | `OFF`               |
| `--enable-debug`                                 | `PHP_DEBUG=ON`                                |                     |
| `--enable-ipv6` (default)                        | `PHP_IPV6=ON`                                 | `ON`                |
|   `--disable-ipv6`                               |   `PHP_IPV6=OFF`                              |                     |
| `--disable-rtld-now` (default)                   | `PHP_RTLD_NOW=OFF`                            | `OFF`               |
|   `--enable-rtld-now`                            | `PHP_RTLD_NOW=ON`                             |                     |
| `--enable-short-tags` (default)                  | `PHP_SHORT_TAGS=ON`                           | `ON`                |
|   `--disable-short-tags`                         | `PHP_SHORT_TAGS=OFF`                          |                     |
| `--disable-zts` (default)                        | `PHP_ZTS=OFF`                                 | `OFF`               |
| `--enable-zts`                                   | `PHP_ZTS=ON`                                  |                     |
| `--disable-dtrace` (default)                     | `PHP_DTRACE=OFF`                              | `OFF`               |
| `--enable-dtrace`                                | `PHP_DTRACE=ON`                               |                     |
| `--disable-fd-setsize` (default)                 | `PHP_FD_SETSIZE=OFF`                          | `OFF`               |
| `--enable-fd-setsize=[NUM]`                      | `PHP_FD_SETSIZE=[NUM]`                        |                     |
| `--with-libdir=[NAME]`                           | `CMAKE_INSTALL_LIBDIR=[NAME]`                 | See GNUInstallDirs  |
| `--with-layout=[TYPE]`                           | `PHP_LAYOUT=[TYPE]`                           | `TYPE=PHP`          |
| **Zend specific configuration**                  |                                               |                     |
| `--enable-gcc-global-regs` (default)             | `ZEND_GCC_GLOBAL_REGS=ON`                     | `ON`                |
| `--disable-gcc-global-regs`                      | `ZEND_GCC_GLOBAL_REGS=OFF`                    |                     |
| `--enable-fiber-asm` (default)                   | `ZEND_FIBER_ASM=ON`                           | `ON`                |
| `--disable-fiber-asm`                            | `ZEND_FIBER_ASM=OFF`                          |                     |
| `--enable-zend-signals` (default)                | `ZEND_SIGNALS=ON`                             | `ON`                |
| `--disable-zend-signals`                         | `ZEND_SIGNALS=OFF`                            |                     |
| `--disable-zend-max-execution-timers` (default)  | `ZEND_MAX_EXECUTION_TIMERS=OFF`               | `OFF`               |
| `--enable-zend-max-execution-timers`             | `ZEND_MAX_EXECUTION_TIMERS=ON`                |                     |
| **PHP sapi modules**                             |                                               |                     |
| `--without-apxs2` (default)                      | `SAPI_APACHE=OFF`                             | `OFF`               |
| `--with-apxs2[=FILE]`                            | `SAPI_APACHE=ON`                              |                     |
| `--enable-cgi` (default)                         | `SAPI_CGI=ON`                                 | `ON`                |
| `--disable-cgi`                                  | `SAPI_CGI=OFF`                                |                     |
| `--enable-cli` (default)                         | `CAPI_CLI=ON`                                 | `ON`                |
| `--disable-cli`                                  | `SAPI_CLI=OFF`                                |                     |
| `--disable-embed` (default)                      | `SAPI_EMBED=OFF`                              | `OFF`               |
| `--enable-embed`                                 | `SAPI_EMBED=ON`                               |                     |
| `--disable-fpm` (default)                        | `SAPI_FPM=OFF`                                | `OFF`               |
| `--enable-fpm`                                   | `SAPI_FPM=ON`                                 |                     |
| `--with-fpm-user[=USER]` (default: `"nobody"`)   | `SAPI_FPM_USER=nobody`                        | `"nobody"`          |
| `--with-fpm-group[=GROUP]` (default: `"nobody"`) | `SAPI_FPM_GROUP=nobody`                       | `"nobody"`          |
| `--without-fpm-systemd` (default)                | `SAPI_FPM_SYSTEMD=OFF`                        | `OFF`               |
| `--with-fpm-systemd`                             | `SAPI_FPM_SYSTEMD=ON`                         |                     |
| `--without-fpm-acl` (default)                    | `SAPI_FPM_ACL=OFF`                            | `OFF`               |
| `--with-fpm-acl`                                 | `SAPI_FPM_ACL=ON`                             |                     |
| `--without-fpm-apparmor` (default)               | `SAPI_FPM_APPARMOR=OFF`                       | `OFF`               |
| `--with-fpm-apparmor`                            | `SAPI_FPM_APPARMOR=ON`                        |                     |
| `--without-fpm-selinux` (default)                | `SAPI_FPM_SELINUX=OFF`                        | `OFF`               |
| `--with-fpm-selinux`                             | `SAPI_FPM_SELINUX=ON`                         |                     |
| `--disable-fuzzer` (default)                     | `SAPI_FUZZER=OFF`                             | `OFF`               |
| `--enable-fuzzer`                                | `SAPI_FUZZER=ON`                              |                     |
| `--disable-litespeed` (default)                  | `SAPI_LITESPEED=OFF`                          | `OFF`               |
| `--enable-litespeed`                             | `SAPI_LITESPEED=ON`                           |                     |
| `--enable-phpdbg` (default)                      | `SAPI_PHPDBG=ON`                              | `ON`                |
| `--disable-phpdbg`                               | `SAPI_PHPDBG=OFF`                             |                     |
| `--disable-phpdbg-debug` (default)               | `SAPI_PHPDBG_DEBUG=OFF`                       | `OFF`               |
| `--enable-phpdbg-debug`                          | `SAPI_PHPDBG_DEBUG=ON`                        |                     |
| `--disable-phpdbg-readline` (default)            | `SAPI_PHPDBG_READLINE=OFF`                    | `OFF`               |
| `--enable-phpdbg-readline`                       | `SAPI_PHPDBG_READLINE=ON`                     |                     |
| **PHP extensions**                               |                                               |                     |
| `--disable-bcmath` (default)                     | `EXT_BCMATH=OFF`                              | `OFF`               |
| `--enable-bcmath`                                | `EXT_BCMATH=ON`                               |                     |
| `--enable-bcmath=shared`                         | `EXT_BCMATH_SHARED=ON`                        |                     |
| `--without-bz2` (default)                        | `EXT_BZ2=OFF`                                 | `OFF`               |
| `--with-bz2[=DIR]`                               | `EXT_BZ2_DIR=DIR`                             |                     |
| `--with-bz2=shared`                              | `EXT_BZ2_SHARED=ON`                           |                     |
| `--disable-calendar` (default)                   | `EXT_CALENDAR=OFF`                            | `OFF`               |
| `--enable-calendar`                              | `EXT_CALENDAR=ON`                             |                     |
| `--enable-calendar=shared`                       | `EXT_CALENDAR_SHARED=ON`                      |                     |
| `--enable-ctype` (default)                       | `EXT_CTYPE=ON`                                | `ON`                |
| `--enable-ctype=shared`                          | `EXT_CTYPE_SHARED=ON`                         |                     |
| `--disable-ctype`                                | `EXT_CTYPE=OFF`                               |                     |
| `--without-curl` (default)                       | `EXT_CURL=OFF`                                | `OFF`               |
| `--with-curl`                                    | `EXT_CURL=ON`                                 |                     |
| `--with-curl=shared`                             | `EXT_CURL_SHARED=ON`                          |                     |
| `--disable-dl-test` (default)                    | `EXT_DL_TEST=OFF`                             | `OFF`               |
| `--enable-dl-test`                               | `EXT_DL_TEST=ON`                              | will be shared      |
| `--enable-dl-test=shared`                        | `EXT_DL_TEST=ON`                              | will be shared      |
| `--enable-dom` (default)                         | `EXT_DOM=ON`                                  | `ON`                |
| `--enable-dom=shared`                            | `EXT_DOM_SHARED=ON`                           |                     |
| `--disable-dom`                                  | `EXT_DOM=OFF`                                 |                     |
| `--without-enchant` (default)                    | `EXT_ENCHANT=OFF`                             | `OFF`               |
| `--with-enchant`                                 | `EXT_ENCHANT=ON`                              |                     |
| `--with-enchant=shared`                          | `EXT_ENCHANT_SHARED=ON`                       |                     |
| `--disable-exif` (default)                       | `EXT_EXIF=OFF`                                | `OFF`               |
| `--enable-exif`                                  | `EXT_EXIF=ON`                                 |                     |
| `--enable-exif=shared`                           | `EXT_EXIF_SHARED=ON`                          |                     |
| `--without-ffi` (default)                        | `EXT_FFI=OFF`                                 | `OFF`               |
| `--with-ffi`                                     | `EXT_FFI=ON`                                  |                     |
| `--with-ffi=shared`                              | `EXT_FFI_SHARED=ON`                           |                     |
| `--enable-fileinfo` (default)                    | `EXT_FILEINFO=ON`                             | `ON`                |
| `--enable-fileinfo=shared`                       | `EXT_FILEINFO_SHARED=ON`                      |                     |
| `--disable-fileinfo`                             | `EXT_FILEINFO=OFF`                            |                     |
| `--enable-filter` (default)                      | `EXT_FILTER=ON`                               | `ON`                |
| `--enable-filter=shared`                         | `EXT_FILTER_SHARED=ON`                        |                     |
| `--disable-filter`                               | `EXT_FILTER=OFF`                              |                     |
| `--disable-ftp` (default)                        | `EXT_FTP=OFF`                                 | `OFF`               |
| `--enable-ftp`                                   | `EXT_FTP=ON`                                  |                     |
| `--enable-ftp=shared`                            | `EXT_FTP_SHARED=ON`                           |                     |
| `--without-openssl-dir` (default)                | `EXT_FTP_SSL=OFF`                             | `OFF`               |
| `--with-openssl-dir`                             | `EXT_FTP_SSL=ON`                              |                     |
| `--disable-gd` (default)                         | `EXT_GD=OFF`                                  | `OFF`               |
| `--enable-gd`                                    | `EXT_GD=ON`                                   |                     |
| `--enable-gd=shared`                             | `EXT_GD_SHARED=ON`                            |                     |
| `--without-external-gd` (default)                | `EXT_GD_EXTERNAL=OFF`                         | `OFF`               |
| `--with-external-gd`                             | `EXT_GD_EXTERNAL=ON`                          |                     |
| `--without-avif` (default)                       | `EXT_GD_AVIF=OFF`                             | `OFF`               |
| `--with-avif`                                    | `EXT_GD_AVIF=ON`                              |                     |
| `--without-webp` (default)                       | `EXT_GD_WEBP=OFF`                             | `OFF`               |
| `--with-webp`                                    | `EXT_GD_WEBP=ON`                              |                     |
| `--without-jpeg` (default)                       | `EXT_GD_JPEG=OFF`                             | `OFF`               |
| `--with-jpeg`                                    | `EXT_GD_JPEG=ON`                              |                     |
| `--without-xpm` (default)                        | `EXT_GD_XPM=OFF`                              | `OFF`               |
| `--with-xpm`                                     | `EXT_GD_XPM=ON`                               |                     |
| `--without-freetype` (default)                   | `EXT_GD_FREETYPE=OFF`                         | `OFF`               |
| `--with-freetype`                                | `EXT_GD_FREETYPE=ON`                          |                     |
| `--disable-gd-jis-conv` (default)                | `EXT_GD_JIS=OFF`                              | `OFF`               |
| `--enable-gd-jis-conv`                           | `EXT_GD_JIS=ON`                               |                     |
| `--without-gettext` (default)                    | `EXT_GETTEXT=OFF`                             | `OFF`               |
| `--with-gettext[=DIR]`                           | `EXT_GETTEXT=ON`                              |                     |
| `--with-gettext=shared`                          | `EXT_GETTEXT_SHARED=ON`                       |                     |
| `--without-gmp` (default)                        | `EXT_GMP=OFF`                                 | `OFF`               |
| `--with-gmp[=DIR]`                               | `EXT_GMP=ON`                                  |                     |
| `--with-gmp=shared`                              | `EXT_GMP_SHARED=ON`                           |                     |
| `--without-mhash` (default)                      | `EXT_HASH_MHASH=OFF`                          | `OFF`               |
| `--with-mhash`                                   | `EXT_HASH_MHASH=ON`                           |                     |
| `--with-iconv` (default)                         | `EXT_ICONV=ON`                                | `ON`                |
| `--with-iconv=shared`                            | `EXT_ICONV_SHARED=ON`                         |                     |
| `--without-iconv`                                | `EXT_ICONV=OFF`                               |                     |
| `--disable-intl` (default)                       | `EXT_INTL=OFF`                                | `OFF`               |
| `--enable-intl`                                  | `EXT_INTL=ON`                                 |                     |
| `--enable-intl=shared`                           | `EXT_INTL_SHARED=ON`                          |                     |
| `--with-libxml` (default)                        | `EXT_LIBXML=ON`                               | `ON`                |
| `--without-libxml`                               | `EXT_LIBXML=OFF`                              |                     |
| `--disable-mbstring` (default)                   | `EXT_MBSTRING=OFF`                            | `OFF`               |
| `--enable-mbstring`                              | `EXT_MBSTRING=ON`                             |                     |
| `--enable-mbstring=shared`                       | `EXT_MBSTRING_SHARED=ON`                      |                     |
| `--enable-mbregex` (default)                     | `EXT_MBSTRING_MBREGEX=ON`                     | `ON`                |
| `--disable-mbregex`                              | `EXT_MBSTRING_MBREGEX=OFF`                    |                     |
| `--disable-mysqlnd` (default)                    | `EXT_MYSQLND=OFF`                             | `OFF`               |
| `--enable-mysqlnd`                               | `EXT_MYSQLND=ON`                              |                     |
| `--enable-mysqlnd=shared`                        | `EXT_MYSQLND_SHARED=ON`                       |                     |
| `--enable-mysqlnd-compression-support` (default) | `EXT_MYSQLND_COMPRESSION=ON`                  | `ON`                |
| `--disable-mysqlnd-compression-support`          | `EXT_MYSQLND_COMPRESSION=OFF`                 |                     |
| `--enable-opcache=shared` (default)              | `EXT_OPCACHE=ON`                              | will be shared      |
| `--enable-opcache`                               | `EXT_OPCACHE=ON`                              | will be shared      |
| `--disable-opcache`                              | `EXT_OPCACHE=OFF`                             |                     |
| `--enable-huge-code-pages` (default)             | `EXT_OPCACHE_HUGE_CODE_PAGES=ON`              | `ON`                |
| `--disable-huge-code-pages`                      | `EXT_OPCACHE_HUGE_CODE_PAGES=OFF`             |                     |
| `--enable-opcache-jit` (default)                 | `EXT_OPCACHE_JIT=ON`                          | `ON`                |
| `--disable-opcache-jit`                          | `EXT_OPCACHE_JIT=OFF`                         |                     |
| `--without-capstone` (default)                   | `EXT_OPCACHE_CAPSTONE=OFF`                    | `OFF`               |
| `--with-capstone`                                | `EXT_OPCACHE_CAPSTONE=ON`                     |                     |
| `--without-openssl` (default)                    | `EXT_OPENSSL=OFF`                             | `OFF`               |
| `--with-openssl`                                 | `EXT_OPENSSL=ON`                              |                     |
| `--with-openssl=shared`                          | `EXT_OPENSSL_SHARED=ON`                       |                     |
| `--without-kerberos` (default)                   | `EXT_OPENSSL_KERBEROS=OFF`                    | `OFF`               |
| `--with-kerberos`                                | `EXT_OPENSSL_KERBEROS=ON`                     |                     |
| `--without-system-ciphers` (default)             | `EXT_OPENSSL_SYSTEM_CIPHERS=OFF`              | `OFF`               |
| `--with-system-ciphers`                          | `EXT_OPENSSL_SYSTEM_CIPHERS=ON`               |                     |
| `--disable-pcntl` (default)                      | `EXT_PCNTL=OFF`                               | `OFF`               |
| `--enable-pcntl`                                 | `EXT_PCNTL=ON`                                |                     |
| `--enable-pcntl=shared`                          | `EXT_PCNTL_SHARED=ON`                         |                     |
| `--without-external-pcre` (default)              | `EXT_PCRE_EXTERNAL=OFF`                       | `OFF`               |
| `--with-external-pcre`                           | `EXT_PCRE_EXTERNAL=ON`                        |                     |
| `--with-pcre-jit` (default)                      | `EXT_PCRE_JIT=ON`                             | `ON`                |
| `--without-pcre-jit`                             | `EXT_PCRE_JIT=OFF`                            |                     |
| `--enable-pdo` (default)                         | `EXT_PDO=ON`                                  | `ON`                |
| `--enable-pdo=shared`                            | `EXT_PDO_SHARED=ON`                           |                     |
| `--disable-pdo`                                  | `EXT_PDO=OFF`                                 |                     |
| `--with-pdo-sqlite` (default)                    | `EXT_PDO_SQLITE=ON`                           | `ON`                |
| `--with-pdo-sqlite=shared`                       | `EXT_PDO_SQLITE_SHARED=ON`                    |                     |
| `--without-pdo-sqlite`                           | `EXT_PDO_SQLITE=OFF`                          |                     |
| `--enable-phar` (default)                        | `EXT_PHAR=ON`                                 | `ON`                |
| `--enable-phar=shared`                           | `EXT_PHAR_SHARED=ON`                          |                     |
| `--disable-phar`                                 | `EXT_PHAR=OFF`                                |                     |
| `--enable-posix` (default)                       | `EXT_POSIX=ON`                                | `ON`                |
| `--enable-posix=shared`                          | `EXT_POSIX_SHARED=ON`                         |                     |
| `--disable-posix`                                | `EXT_POSIX=OFF`                               |                     |
| `--without-pspell` (default)                     | `EXT_PSPELL=OFF`                              | `OFF`               |
| `--with-pspell`                                  | `EXT_PSPELL=ON`                               |                     |
| `--with-pspell=shared`                           | `EXT_PSPELL_SHARED=ON`                        |                     |
| `--without-libedit` (default)                    | `EXT_READLINE=OFF`                            | `OFF`               |
| `--with-libedit`                                 | `EXT_READLINE=ON`                             |                     |
| `--without-readline` (default)                   | `EXT_READLINE=OFF`                            | `OFF`               |
| `--with-readline`                                | `EXT_READLINE=ON;EXT_READLINE_LIBREADLINE=ON` |                     |
| `--enable-session` (default)                     | `EXT_SESSION=ON`                              | `ON`                |
| `--enable-session=shared`                        | `EXT_SESSION_SHARED=ON`                       |                     |
| `--disable-session`                              | `EXT_SESSION=OFF`                             |                     |
| `--without-mm` (default)                         | `EXT_SESSION_MM=OFF`                          | `OFF`               |
| `--with-mm[=DIR]`                                | `EXT_SESSION_MM=[ON\|path/to/mm]`             |                     |
| `--disable-shmop` (default)                      | `EXT_SHMOP=OFF`                               | `OFF`               |
| `--enable-shmop`                                 | `EXT_SHMOP=ON`                                |                     |
| `--enable-shmop=shared`                          | `EXT_SHMOP_SHARED=ON`                         |                     |
| `--enable-simplexml` (default)                   | `EXT_SIMPLEXML=ON`                            | `ON`                |
| `--enable-simplexml=shared`                      | `EXT_SIMPLEXML_SHARED=ON`                     |                     |
| `--disable-simplexml`                            | `EXT_SIMPLEXML=OFF`                           |                     |
| `--without-snmp` (default)                       | `EXT_SNMP=OFF`                                | `OFF`               |
| `--with-snmp`                                    | `EXT_SNMP=ON`                                 |                     |
| `--with-snmp=shared`                             | `EXT_SNMP_SHARED=ON`                          |                     |
| `--disable-soap` (default)                       | `EXT_SOAP=OFF`                                | `OFF`               |
| `--enable-soap`                                  | `EXT_SOAP=ON`                                 |                     |
| `--enable-soap=shared`                           | `EXT_SOAP_SHARED=ON`                          |                     |
| `--disable-sockets` (default)                    | `EXT_SOCKETS=OFF`                             | `OFF`               |
| `--enable-sockets`                               | `EXT_SOCKETS=ON`                              |                     |
| `--enable-sockets=shared`                        | `EXT_SOCKETS_SHARED=ON`                       |                     |
| `--without-sodium` (default)                     | `EXT_SODIUM=OFF`                              | `OFF`               |
| `--with-sodium`                                  | `EXT_SODIUM=ON`                               |                     |
| `--with-sodium=shared`                           | `EXT_SODIUM_SHARED=ON`                        |                     |
| `--with-sqlite3` (default)                       | `EXT_SQLITE3=ON`                              | `ON`                |
| `--with-sqlite3=shared`                          | `EXT_SQLITE3_SHARED`                          |                     |
| `--without-sqlite3`                              | `EXT_SQLITE3=OFF`                             |                     |
| `--without-external-libcrypt` (default)          | `EXT_STANDARD_EXTERNAL_LIBCRYPT=OFF`          | `OFF`               |
| `--with-external-libcrypt`                       | `EXT_STANDARD_EXTERNAL_LIBCRYPT=ON`           |                     |
| `--without-password-argon2` (default)            | `EXT_STANDARD_ARGON2=OFF`                     | `OFF`               |
| `--with-password-argon2`                         | `EXT_STANDARD_ARGON2=ON`                      |                     |
| `--disable-sysvmsg` (default)                    | `EXT_SYSVMSG=OFF`                             | `OFF`               |
| `--enable-sysvmsg`                               | `EXT_SYSVMSG=ON`                              |                     |
| `--enable-sysvmsg=shared`                        | `EXT_SYSVMSG_SHARED=ON`                       |                     |
| `--disable-sysvsem` (default)                    | `EXT_SYSVSEM=OFF`                             | `OFF`               |
| `--enable-sysvsem`                               | `EXT_SYSVSEM=ON`                              |                     |
| `--enable-sysvsem=shared`                        | `EXT_SYSVSEM_SHARED=ON`                       |                     |
| `--disable-sysvshm` (default)                    | `EXT_SYSVSHM=OFF`                             | `OFF`               |
| `--enable-sysvshm`                               | `EXT_SYSVSHM=ON`                              |                     |
| `--enable-sysvshm=shared`                        | `EXT_SYSVSHM_SHARED=ON`                       |                     |
| `--without-tidy` (default)                       | `EXT_TIDY=OFF`                                | `OFF`               |
| `--with-tidy[=DIR]`                              | `EXT_TIDY=ON`                                 |                     |
| `--with-tidy=shared`                             | `EXT_TIDY_SHARED=ON`                          |                     |
| `--enable-tokenizer` (default)                   | `EXT_TOKENIZER=ON`                            | `ON`                |
| `--enable-tokenizer=shared`                      | `EXT_TOKENIZER_SHARED=ON`                     |                     |
| `--disable-tokenizer`                            | `EXT_TOKENIZER=OFF`                           |                     |
| `--enable-xml` (default)                         | `EXT_XML=ON`                                  | `ON`                |
| `--enable-xml=shared`                            | `EXT_XML_SHARED=ON`                           |                     |
| `--disable-xml`                                  | `EXT_XML=OFF`                                 |                     |
| `--without-expat` (default)                      | `EXT_XML_EXPAT=OFF`                           | `OFF`               |
| `--with-expat`                                   | `EXT_XML_EXPAT=ON`                            |                     |
| `--without-xsl` (default)                        | `EXT_XSL=OFF`                                 | `OFF`               |
| `--with-xsl`                                     | `EXT_XSL=ON`                                  |                     |
| `--with-xsl=shared`                              | `EXT_XSL_SHARED=ON`                           |                     |
| `--enable-xmlreader` (default)                   | `EXT_XMLREADER=ON`                            | `ON`                |
| `--enable-xmlreader=shared`                      | `EXT_XMLREADER_SHARED=ON`                     |                     |
| `--disable-xmlreader`                            | `EXT_XMLREADER=OFF`                           |                     |
| `--enable-xmlwriter` (default)                   | `EXT_XMLWRITER=ON`                            | `ON`                |
| `--enable-xmlwriter=shared`                      | `EXT_XMLWRITER_SHARED=ON`                     |                     |
| `--disable-xmlwriter`                            | `EXT_XMLWRITER=OFF`                           |                     |
| `--disable-zend-test` (default)                  | `EXT_ZEND_TEST=OFF`                           | `OFF`               |
| `--enable-zend-test`                             | `EXT_ZEND_TEST=ON`                            |                     |
| `--enable-zend-test=shared`                      | `EXT_ZEND_TEST_SHARED=ON`                     |                     |
| `--without-zip` (default)                        | `EXT_ZIP=OFF`                                 | `OFF`               |
| `--with-zip`                                     | `EXT_ZIP=ON`                                  |                     |
| `--with-zip=shared`                              | `EXT_ZIP_SHARED=ON`                           |                     |
| `--without-zlib` (default)                       | `EXT_ZLIB=OFF`                                | `OFF`               |
| `--with-zlib`                                    | `EXT_ZLIB=ON`                                 |                     |
| `--with-zlib=shared`                             | `EXT_ZLIB_SHARED=ON`                          |                     |

List of configure environment variables:

These are passed as `./configure VAR=VALUE`.

| configure                       | CMake                             | Default value/notes            |
| ------------------------------- | --------------------------------- | ------------------------------ |
| **3rd party variables**         |                                   |                                |
| `LDFLAGS="..."`                 | `CMAKE_EXE_LINKER_FLAGS="..."`    |                                |
|                                 | `CMAKE_SHARED_LINKER_FLAGS="..."` |                                |
| **PHP variables**               |                                   |                                |
| `PHP_EXTRA_VERSION="-acme"`     | `PHP_VERSION_LABEL="-acme"`       | `-dev` or empty                |
| `PHP_UNAME="ACME Linux"`        | `PHP_UNAME="ACME Linux"`          | `uname -a` ouput override      |
| `PHP_BUILD_SYSTEM="ACME Linux"` | `PHP_BUILD_SYSTEM="ACME Linux"`   | `uname -a` ouput               |
| `PHP_BUILD_PROVIDER="ACME"`     | `PHP_BUILD_PROVIDER="ACME"`       | Additional build system info   |
| `PHP_BUILD_COMPILER="ACME"`     | `PHP_BUILD_COMPILER="ACME"`       | Additional build system info   |
| `PHP_BUILD_ARCH="ACME"`         | `PHP_BUILD_ARCH="ACME"`           | Additional build system info   |
| `EXTENSION_DIR="path/to/ext"`   | `PHP_EXTENSION_DIR="path/to/ext"` | Override the INI extension_dir |
| **Available only in CMake**     |                                   |                                |
|                                 | `BUILD_SHARED_LIBS=ON`            | Build all extensions as shared |

When running `make VAR=VALUE` commands, the following environment variables are available:

| make with PHP                   | CMake                             | Default value/notes            |
| ------------------------------- | --------------------------------- | ------------------------------ |
| `INSTALL_ROOT="..."`            | `CMAKE_INSTALL_PREFIX="..."`      | Override the installation dir  |
|                                 | or `cmake --install --prefix`     |                                |

### 9.9. CMake generators for building PHP

When using CMake to build PHP, you have the flexibility to choose from various
build systems through the concept of _generators_. CMake generators determine
the type of project files or build scripts that CMake generates from your
`CMakeLists.txt` file. In this example, we will check the following generators:
Unix Makefiles and Ninja.

#### 9.9.1. Unix Makefiles (default)

The Unix Makefiles generator is the most common and widely used generator for
building projects on Unix-like systems, including Linux and macOS. It generates
traditional `Makefile` that can be processed by the `make` command. To use the
Unix Makefiles generator, you simply specify it as an argument when running
CMake in your build directory.

To generate the `Makefile` for building PHP, create a new directory (often
called `build` or `cmake-build`) and navigate to it using the terminal. Then,
execute the following CMake command:

```sh
cmake -G "Unix Makefiles" /path/to/php-src
```

Replace `/path/to/php-src` with the actual path to the PHP source code on
your system (in case build directory is the same as the source directory, use
`.`). CMake will process the `CMakeLists.txt` file in the source directory and
generate the `Makefile` in the current build directory.

After the Makefiles are generated, you can use the make command to build PHP:

```sh
make
```

The make command will build the PHP binaries and libraries according to the
configuration specified in the `CMakeLists.txt` file. If you want to speed up
the build process, you can use the `-j` option to enable parallel builds, taking
advantage of multiple CPU cores:

```sh
make -j$(nproc) # number of CPU cores you want to utilize.
```

#### 9.9.2. Ninja

[Ninja](https://ninja-build.org/) is another build system supported by CMake and
is known for its fast build times due to its minimalistic design. To use the
Ninja generator, you need to have Ninja installed on your system. Most package
managers on Unix systems offer Ninja as a package, so you can install it easily.

To generate Ninja build files for building PHP, navigate to your build directory
in the terminal and run the following CMake command:

```sh
cmake -G "Ninja" /path/to/php-src
```

Again, replace `/path/to/php/src` with the actual path to the PHP source code.
CMake will generate the Ninja build files in the current directory.

To build PHP with Ninja, execute the following command:

```sh
ninja
```

Ninja will then handle the build process based on the CMake configuration.
Similar to the Unix Makefiles generator, you can use the `-j` option to enable
parallel builds with Ninja (by default, however, `-j` is already set to the
number of available CPU cores on your system):

```sh
ninja -j$(nproc)
```

### 9.10. CMake presets

The `CMakePresets.json` and `CMakeUserPresets.json` files in project root
directory are available since CMake 3.19 for sharing build configurations.

Instead of manually typing `cmake . -DFOO=BAR ...` in command line, users can
simply store these configuration options in JSON file and have a shareable build
settings for continuous integration, development, bug reporting etc.

The [CMakePresets.json](/cmake/CMakePresets.json) example file includes some
common configuration and build settings.

To use the CMake presets:

```sh
# Configure project, replace "default" with the name of the "configurePresets".
cmake --preset default

# Build project using the "default" build preset.
cmake --build --preset default
```

File `CMakeUserPresets.json` is ignored in Git because it is intended for user
specific configuration.

### 9.11. CMake GUI

With CMake there comes also a basic graphical user interface to configure and
generate the build system.

Inside a CMake project, run:

```sh
cmake-gui .
```

![CMake GUI](docs/images/cmake-gui.png)

Here the build configuration can be done, such as enabling the PHP extensions,
adjusting the build options and similar.

CMake GUI makes it simpler to see available build options and settings and it
also conveniently hides and sets the dependent options. For example, if some PHP
extension provides multiple configuration options and it is disabled, the
dependent options won't be displayed after configuration.

![CMake GUI setup](docs/images/cmake-gui-2-setup.png)

After setting up, press the `Configure` button to start the configuration phase
and prepare the build configuration. The `Generate` buttons can then generate
the chosen build system.

![CMake GUI configuration](docs/images/cmake-gui-3.png)

GUI is only meant to configure and generate the build in user friendly way.
Building the sources to binaries can be then done in command line or IDE.

```sh
cmake --build --preset default
```

### 9.12. Testing

PHP source code tests (`*.phpt` files) are written in PHP and are executed with
`run-tests.php` script from the very beginning of the PHP development. When
building PHP with Autotools the tests are usually run by:

```sh
make TEST_PHP_ARGS=-j10 test
```

CMake ships with a `ctest` utility that can run also this in a similar way.

To enable testing the `enable_testing()` is added to the `CMakeLists.txt` file
and the tests are added with `add_test()`.

To run the tests using CMake in command line:

```sh
ctest --progress --verbose
```

The `--progress` option displays a progress if there's more tests set, and
`--verbose` option outputs additional info to the stdout. In PHP case the
`--verbose` is needed so the output of the `run-tests.php` script is displayed.

CMake testing also supports presets so configuration can be coded and shared
using the `CMakePresets.json` file and its `testPresets` field.

```sh
ctest --preset unix-full
```

### 9.13. Performance

When CMake is doing configuration phase, the profiling options can be used to do
build system performance analysis of CMake script.

```sh
cmake . --profiling-output ./profile.json --profiling-format google-trace
```

![CMake profiling](docs/images/cmake-profiling.png)

### 9.14. Installing PHP with CMake

See [PHP installation](/docs/php-installation.md) chapter.

## 10. See more

### 10.1. Autotools

Useful resources to learn more about Autoconf and Autotools in general:

* [Autoconf documentation](https://www.gnu.org/software/autoconf/manual/index.html)
* [Autotools Mythbuster](https://autotools.info/) - guide to Autotools
* [GNU Autoconf Archive](https://github.com/autoconf-archive/autoconf-archive) -
  community collection of Autoconf macros.

### 10.2. CMake

Useful resources to learn more about CMake:

* [CMake documentation](https://cmake.org/documentation/)
* [Effective Modern CMake](https://gist.github.com/mbinna/c61dbb39bca0e4fb7d1f73b0d66a4fd1)
* [Awesome CMake](https://github.com/onqtam/awesome-cmake)

### 10.3. CMake and PHP

Existing CMake and PHP discussions and resources:

* [php-cmake](https://github.com/gloob/php-cmake) - CMake implementation in PHP.
* [CMake discussion on PHP mailing list](https://externals.io/message/116655)

### 10.4. PHP Internals

Useful resources to learn more about PHP internals:

* [PHP Internals Book](https://www.phpinternalsbook.com/)
