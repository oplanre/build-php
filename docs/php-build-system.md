# CMake-based PHP build system

This document describes how CMake-based PHP build system in this repository
works and how it can be used.

## Index

* [1. Directory structure](#1-directory-structure)
* [2. CMake usage](#2-cmake-usage)
  * [2.1. CMake-based PHP build system diagram](#21-cmake-based-php-build-system-diagram)
  * [2.2. CMake generators for building PHP](#22-cmake-generators-for-building-php)
    * [2.2.1. Unix Makefiles (default)](#221-unix-makefiles-default)
    * [2.2.2. Ninja](#222-ninja)
* [3. CMake minimum version for PHP](#3-cmake-minimum-version-for-php)
* [4. Interface library](#4-interface-library)
* [5. PHP CMake modules](#5-php-cmake-modules)
  * [5.1. SearchLibraries](#51-searchlibraries)
  * [5.2. CheckBuiltin](#52-checkbuiltin)
* [6. PHP extensions](#6-php-extensions)
  * [6.1. Properties](#61-properties)
* [7. PHP SAPI (Server API) modules](#7-php-sapi-server-api-modules)
* [8. Parser and lexer files](#8-parser-and-lexer-files)
* [9. Performance](#9-performance)
* [10. Testing](#10-testing)

## 1. Directory structure

Directory structure from the CMake perspective:

```sh
<php-src>/
 └─ cmake/                   # CMake-based PHP build system files
    └─ modules/              # Project specific CMake modules
       ├─ PHP/               # PHP utility modules
       ├─ Zend/              # Zend utility modules
       ├─ Find*.cmake        # Find modules that support the find_package()
       └─ *.cmake            # Any possible additional utility modules
    ├─ presets/              # Additional presets included in CMakePresets.json
    └─ *.cmake               # Various CMake configurations and tools
 └─ ext/
    └─ date/
       └─ CMakeLists.txt     # Extension's CMake file
 └─ main/
    ├─ CMakeLists.txt        # CMake file for main binding
    ├─ php_config.cmake.h.in # Configuration header template
    └─ php_version.h         # Generated by release managers using `configure`
 └─ pear/
    └─ CMakeLists.txt        # CMake file for PEAR
 └─ sapi/
    └─ cli/
       └─ CMakeLists.txt     # CMake file for PHP SAPI module
 └─ scripts/
    └─ CMakeLists.txt        # CMake file for creating scripts files
 └─ TSRM/
    └─ CMakeLists.txt        # CMake file for thread safe resource manager
 └─ Zend/
    └─ CMakeLists.txt        # CMake file for Zend engine
 ├─ CMakeLists.txt           # Root CMake file
 ├─ CMakePresets.json        # Main CMake presets file
 └─ CMakeUserPresets.json    # Local CMake presets overrides
```

The following diagram briefly displays, how PHP libraries (in terms of a build
system) are linked together:

![Diagram how PHP libraries are linked together](/docs/images/links.svg)

## 2. CMake usage

Using CMake in command line:

```sh
cmake .
cmake --build .
```

### 2.1. CMake-based PHP build system diagram

![CMake-based PHP build system diagram](/docs/images/cmake.svg)

### 2.2. CMake generators for building PHP

When using CMake to build PHP, you have the flexibility to choose from various
build systems through the concept of _generators_. CMake generators determine
the type of project files or build scripts that CMake generates from your
`CMakeLists.txt` file.

#### 2.2.1. Unix Makefiles (default)

The Unix Makefiles generator is the most common and widely used generator for
building projects on Unix-like systems, including Linux and macOS. It generates
traditional `Makefile` that can be processed by the `make` command. To use the
Unix Makefiles generator, you simply specify it as an argument when running
CMake in your build directory.

To generate the `Makefile` for building PHP, create a new directory (often
called `build` or `cmake-build`) and navigate to it using the terminal. Then,
execute the following CMake command:

```sh
cmake -G "Unix Makefiles" /path/to/php-src
```

Replace `/path/to/php-src` with the actual path to the PHP source code on
your system (in case build directory is the same as the source directory, use
`.`). CMake will process the `CMakeLists.txt` file in the source directory and
generate the `Makefile` in the current build directory.

After the Makefiles are generated, you can use the make command to build PHP:

```sh
make
```

The make command will build the PHP binaries and libraries according to the
configuration specified in the `CMakeLists.txt` file. If you want to speed up
the build process, you can use the `-j` option to enable parallel builds, taking
advantage of multiple CPU cores:

```sh
make -j$(nproc) # number of CPU cores you want to utilize.
```

#### 2.2.2. Ninja

[Ninja](https://ninja-build.org/) is another build system supported by CMake and
is known for its fast build times due to its minimalistic design. To use the
Ninja generator, you need to have Ninja installed on your system. Most package
managers on Unix systems offer Ninja as a package, so you can install it easily.

To generate Ninja build files for building PHP, navigate to your build directory
in the terminal and run the following CMake command:

```sh
cmake -G "Ninja" /path/to/php-src
```

Again, replace `/path/to/php/src` with the actual path to the PHP source code.
CMake will generate the Ninja build files in the current directory.

To build PHP with Ninja, execute the following command:

```sh
ninja
```

Ninja will then handle the build process based on the CMake configuration.

## 3. CMake minimum version for PHP

The minimum required version of CMake is defined in the top project file
`CMakeLists.txt` using the `cmake_minimum_required()`. Picking the minimum
required CMake version is a compromise between CMake functionalities and CMake
version available on the operating system.

* 3.17
  * `CMAKE_CURRENT_FUNCTION_LIST_DIR` variable
* 3.19
  * `check_compiler_flag()`, `check_source_compiles()`, `check_source_runs()` to
    generalize the `check_<LANG>_...()`
  * `CMakePresets.json` for sharing build configurations
* 3.20
  * `CMAKE_C_BYTE_ORDER`, otherwise manual check should be done
  * `"version": 2` in `CMakePresets.json`
  * `Intl::Intl` IMPORTED target with CMake's FindIntl module
* 3.21
  * `"version": 3` in `CMakePresets.json` (for the `installDir` field)
* 3.22
  * Full condition syntax in `cmake_dependent_option()`
* 3.23
  * `target_sources(FILE_SET)`, otherwise `install(FILES)` should be used when
    installing files to their destinations
  * `"version": 4` in `CMakePresets.json` (for the `include` field)
* 3.24
  * `CMAKE_COLOR_DIAGNOSTICS`
  * `CMAKE_COMPILE_WARNING_AS_ERROR`, otherwise INTERFACE library should be used
* 3.25
  * `block()` command
  * New `try_run` signature
* 3.27
  * `COMPILE_ONLY` generator expression
* 3.29
  * `CMAKE_LINKER_TYPE`

Currently, the CMake minimum version is set to **3.25** without looking at CMake
available version on the current systems out there. This will be updated more
properly in the future.

CMake versions scheme across the systems is available at
[pkgs.org](https://pkgs.org/download/cmake).

## 4. Interface library

The `php_configuration` library (aliased `PHP::configuration`) holds
project-wide compilation flags, definitions, libraries and include directories.

It is analogous to a global configuration class, where configuration is set
during the configuration phase and then linked to targets that need the
configuration.

It can be linked to a given target:

```cmake
target_link_libraries(target_name PRIVATE PHP::configuration)
```

## 5. PHP CMake modules

All PHP CMake utility modules are located in the `cmake/modules/PHP` directory.

Here are listed only those that are important when adapting PHP build system.
Otherwise, a new module can be added by creating a new CMake file
`cmake/modules/PHP/NewModule.cmake` and then include it in the CMake code:

```cmake
include(PHP/NewModule)
```

### 5.1. SearchLibraries

The `SearchLibraries` module exposes a `php_search_libraries` function:

```cmake
include(PHP/SearchLibraries)

php_search_libraries(
  function_name
  "header.h;header_2.h"
  HAVE_FUNCTION_NAME
  FUNCTION_LIBRARY
  LIBRARIES lib_1 lib_2...
)

if(FUNCTION_LIBRARY)
  target_link_libraries(target PRIVATE ${FUNCTION_LIBRARY})
endif()
```

### 5.2. CheckBuiltin

The `CheckBuiltin` module exposes `php_check_builtin` function to check various
sorts of builtins:

```cmake
include(PHP/CheckBuiltin)

php_check_builtin(__builtin_clz PHP_HAVE_BUILTIN_CLZ)
```

## 6. PHP extensions

PHP has several ways to install PHP extensions:

* Statically linked to PHP

  This is the default way. Extension is built together with PHP SAPI and no
  enabling is needed in the `php.ini` configuration.

* Shared modules

  This installs the extension as dynamically loadable library. Extension to be
  visible in the PHP SAPI (see `php -m`) needs to be also manually enabled in
  the `php.ini` configuration:

  ```ini
  extension=php_extension_lowercase_name
  ```

  This will load the PHP extension module file (shared object) located in the
  extension directory (the `extension_dir` INI directive). File can have `.so`
  extension on *nix systems, `.dll` on Windows, and possibly other extensions
  such as `.sl` on certain HP-UX systems, or `.dylib` on macOS.

The following extensions are always enabled and are part of the overall PHP
engine source code:

* `ext/date`
* `ext/hash`
* `ext/json`
* `ext/pcre`
* `ext/random`
* `ext/reflection`
* `ext/spl`
* `ext/standard`

PHP extensions ecosystem also consists of the [PECL](https://pecl.php.net)
extensions. These can be installed with a separate tool `pecl`:

```sh
pecl install php_extension_name
```

PECL tool is a simple shell script wrapper around the PHP code as part of the
[pear-core](https://github.com/pear/pear-core/blob/master/scripts/pecl.sh)
repository.

To build PHP extensions with CMake, a `CMakeLists.txt` file needs to be added to
the extension's source directory.

Example of `CMakeLists.txt` for PHP extensions can be found in the
`ext/skeleton` directory.

### 6.1. Properties

Extensions can utilize the following custom CMake properties:

* `PHP_ZEND_EXTENSION`

  This property designates the extension as a Zend extension rather than a
  standard PHP extension. Zend extensions function similarly to regular PHP
  extensions, but they are loaded using the `zend_extension` INI directive and
  possess an internally distinct structure with additional hooks. Typically
  employed for advanced functionalities like debuggers and profilers, Zend
  extensions offer enhanced capabilities.

  ```cmake
  set_target_properties(php_<extension_name> PROPERTIES PHP_ZEND_EXTENSION TRUE)
  ```

## 7. PHP SAPI (Server API) modules

PHP works through the concept of SAPI modules located in the `sapi` directory.

When running PHP on the command line, the cli SAPI module is used:

```sh
/sapi/cli/php -v
```

* [Embed SAPI module](/docs/embed.md)

There are other SAPI modules located in the ecosystem:

* [frankenphp](https://github.com/dunglas/frankenphp)
* [ngx-php](https://github.com/rryqszq4/ngx-php)
* ...

## 8. Parser and lexer files

Some source files are generated with 3rd party tools. These include so called
parser and lexer files which are generated with
[bison](https://www.gnu.org/software/bison/) and [re2c](https://re2c.org/).

Parser files are generated with `bison` tool from `*.y` source files to C source
code and header files.

Lexer files are generated with `re2c` tool from `*.l` and `*.re` source files to
C source code and header files.

To use `bison` and `re2c` in CMake there are
`FindBison` and `FindRE2C` modules that provide `bison_target()` and
`re2c_target()` commands.
[FindBison](https://cmake.org/cmake/help/latest/module/FindBISON.html) is a
CMake built-in module, while FindRE2C is manually created and added at
`cmake/modules/FindRE2C`.

Files related to `bison` and `re2c`:

```sh
<php-src>/
 └─ cmake/
    └─ modules/
       └─ FindRE2C.cmake            # re2c CMake find module, bison is found via
                                    # CMake built-in find module
    └─ Requirements.cmake           # Minimum bison and re2c settings
 └─ ext/
    └─ date/
       └─ lib/
          ├─ parse_date.c           # Generated with re2c 0.15.3
          └─ parse_iso_intervals.c  # Generated with re2c 0.15.3
    └─ ffi/
       └─ ffi_parser.c              # Generated by https://github.com/dstogov/llk
    └─ json/
       ├─ json_parser.tab.c         # Generated with bison
       ├─ json_parser.tab.h         # Generated with bison
       ├─ json_parser.y             # Parser source
       ├─ json_scanner.c            # Generated with re2c
       ├─ json_scanner.re           # Lexer source
       └─ php_json_scanner_defs.h   # Generated with re2c
    └─ pdo/
       ├─ pdo_sql_parser.c          # Generated with re2c
       └─ pdo_sql_parser.re         # Source for re2c
    └─ phar/
       ├─ phar_path_check.c         # Generated with re2c
       └─ phar_path_check.re        # Source for re2c
    └─ standard/
       ├─ url_scanner_ex.c          # Generated with re2c
       ├─ url_scanner_ex.re         # Source for re2c
       ├─ var_unserializer.c        # Generated with re2c
       └─ var_unserializer.re       # Source for re2c
 └─ sapi/
    └─ phpdbg/
       ├─ phpdbg_lexer.c            # Generated with re2c
       ├─ phpdbg_lexer.l            # Source for re2c
       ├─ phpdbg_parser.c           # Generated with bison
       ├─ phpdbg_parser.h           # Generated with bison
       ├─ phpdbg_parser.y           # Source for bison
       └─ phpdbg_parser.output      # Generated with bison
 └─ Zend/
    ├─ zend_ini_parser.c            # Generated with bison
    ├─ zend_ini_parser.h            # Generated with bison
    ├─ zend_ini_parser.output       # Generated with bison
    ├─ zend_ini_parser.y            # Parser source
    ├─ zend_ini_scanner.c           # Generated with re2c
    ├─ zend_ini_scanner.l           # Lexer source
    ├─ zend_ini_scanner_defs.h      # Generated with re2c
    ├─ zend_language_parser.c       # Generated with bison
    ├─ zend_language_parser.h       # Generated with bison
    ├─ zend_language_parser.output  # Generated with bison
    ├─ zend_language_parser.y       # Parser source
    ├─ zend_language_scanner_defs.h # Generated with re2c
    ├─ zend_language_scanner.c      # Generated with re2c
    └─ zend_language_scanner.l      # Lexer source
```

## 9. Performance

When CMake is doing configuration phase, the profiling options can be used to do
build system performance analysis of CMake files.

```sh
cmake --profiling-output ./profile.json --profiling-format google-trace ../php-src
```

![CMake profiling](/docs/images/cmake-profiling.png)

## 10. Testing

PHP source code tests (`*.phpt` files) are written in PHP and are executed with
`run-tests.php` script from the very beginning of the PHP development. When
building PHP with Autotools the tests are usually run by:

```sh
make TEST_PHP_ARGS=-j10 test
```

CMake ships with a `ctest` utility that can run PHP tests in a similar way.

To enable testing the `enable_testing()` is added to the `CMakeLists.txt` file
and the tests are added with `add_test()`.

To run the tests using CMake on the command line:

```sh
ctest --progress --verbose
```

The `--progress` option displays a progress if there are more tests, and
`--verbose` option outputs additional info to the stdout. In PHP case the
`--verbose` is needed so the output of the `run-tests.php` script is displayed.

CMake testing also supports presets so configuration can be coded and shared
using the `CMakePresets.json` file and its `testPresets` field.

```sh
ctest --preset all-enabled
```
